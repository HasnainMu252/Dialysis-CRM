// server/controllers/auth.controller.js
import jwt from "jsonwebtoken";
import User ,  {RoleEnum} from "../models/user.model.js";

import Patient from "../models/patient.model.js";

// helper: sign token for staff/admin users
const signUserToken = (id) =>
  jwt.sign({ id }, process.env.JWT_SECRET, {
    expiresIn: process.env.JWT_EXPIRES || "7d",
  });

/**
 * =========================
 * STAFF/ADMIN AUTH
 * =========================
 */

// POST /api/auth/register
export const register = async (req, res) => {
  try {
    const { name, email, password, role } = req.body;

    if (!name || !email || !password) {
      return res.status(400).json({ success: false, message: "Missing required fields" });
    }

    // role validate (only if role provided)
    if (role && !RoleEnum.includes(role)) {
      return res.status(400).json({ success: false, message: "Invalid role" });
    }

    const exists = await User.findOne({ email: email.toLowerCase() });
    if (exists) {
      return res.status(409).json({ success: false, message: "Email already registered" });
    }

    const user = await User.create({
      name,
      email,
      password,
      role: role || undefined, // default Nurse schema me set ho jayega
    });

    // Ensure that the userId is included in the response
    const formattedUser = {
      userId: user.userId, // This is the unique userId created
      id: user._id,
      name: user.name,
      email: user.email,
      role: user.role,
      active: user.active,
    };

    return res.status(201).json({
      success: true,
      message: "Registered",
      user: formattedUser,
    });
  } catch (e) {
    return res.status(500).json({ success: false, message: "Server error", error: e.message });
  }
};


// POST /api/auth/login
export const login = async (req, res) => {
  try {
    const { email, password } = req.body;

    if (!email || !password)
      return res.status(400).json({ message: "Email and password are required" });

    const cleanEmail = String(email).toLowerCase().trim();

    const user = await User.findOne({ email: cleanEmail });
    if (!user) return res.status(400).json({ message: "Invalid credentials" });

    const ok = await user.comparePassword(password);
    if (!ok) return res.status(400).json({ message: "Invalid credentials" });

    const token = signUserToken(user._id);

    return res.json({
      user: { id: user._id, name: user.name, email: user.email, role: user.role },
      token,
    });
  } catch (err) {
    console.error("❌ Login error:", err);
    return res.status(500).json({ message: "Server error", error: err.message });
  }
};

// GET /api/auth/me  (protected by requireAuth)
export const me = async (req, res) => {
  // requireAuth should attach req.user
  return res.json({ user: req.user });
};

/**
 * =========================
 * PATIENT AUTH
 * =========================
 */

// POST /api/auth/patient-register (PUBLIC)
export const patientRegister = async (req, res) => {
  try {
    const {
      firstName,
      lastName,
      dob,
      gender,
      phone,
      email,
      password,
      address,
    } = req.body;

    if (!firstName || !lastName || !dob || !gender || !phone || !email || !password || !address) {
      return res.status(400).json({ message: "Missing required fields" });
    }

    const cleanEmail = String(email).toLowerCase().trim();

    const exists = await Patient.findOne({ email: cleanEmail });
    if (exists) return res.status(400).json({ message: "Email already in use" });

    // ✅ MRN auto generated by your Patient model pre("validate")
    const patient = await Patient.create({
      firstName: String(firstName).trim(),
      lastName: String(lastName).trim(),
      dob, // your schema expects Date (string is OK)
      gender,
      phone: String(phone).trim(),
      email: cleanEmail,
      password,
      address: String(address).trim(),
      status: "Pending", // ✅ your requirement
    });

    const token = jwt.sign(
      {
        patientId: patient._id,
        mrn: patient.mrn,
        role: "Patient",
        tokenType: "patient",
      },
      process.env.JWT_SECRET,
      { expiresIn: "7d" }
    );

    return res.status(201).json({
      token,
      patient: {
        mrn: patient.mrn,
        firstName: patient.firstName,
        lastName: patient.lastName,
        email: patient.email,
        status: patient.status,
      },
    });
  } catch (err) {
    console.error("❌ patientRegister error:", err);
    return res.status(500).json({ message: "Server error", error: err.message });
  }
};

// POST /api/auth/patient-login
export const patientLogin = async (req, res) => {
  try {
    const { email, password } = req.body;

    if (!email || !password) {
      return res.status(400).json({ message: "Email and password are required" });
    }

    const cleanEmail = String(email).toLowerCase().trim();

    const patient = await Patient.findOne({ email: cleanEmail });
    if (!patient) {
      return res.status(400).json({ message: "Invalid email or password" });
    }

    const ok = await patient.comparePassword(password);
    if (!ok) {
      return res.status(400).json({ message: "Invalid email or password" });
    }

    // ✅ block login unless Active (AFTER patient exists)
    if (patient.status !== "Active") {
      return res.status(403).json({ message: "Patient account is not active" });
    }

    const token = jwt.sign(
      {
        patientId: patient._id,
        mrn: patient.mrn,
        role: "Patient",
        tokenType: "patient",
      },
      process.env.JWT_SECRET,
      { expiresIn: "7d" }
    );

    return res.json({
      token,
      patient: {
        mrn: patient.mrn,
        firstName: patient.firstName,
        lastName: patient.lastName,
        email: patient.email,
        status: patient.status,
      },
    });
  } catch (err) {
    console.error("❌ patientLogin error:", err);
    return res.status(500).json({ message: "Server error" });
  }
};
